<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ficha de Inscrição da Comunidade</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- CSS Embutido -->
    <style>
        body {
          font-family: "Inter", sans-serif;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        /* Estilo para placeholder de select (quando value="") */
        .form-select:invalid {
          color: #6c757d;
        }
        .form-select option {
          color: #333;
        }

        .form-control[type="date"]:invalid,
        .form-control[type="date"]::placeholder {
          color: #6c757d;
          opacity: 1;
        }

        .input-error {
          border: 1px solid #dc3545 !important;
          box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
        }
        .custom-select-wrapper .input-error {
          border-right: none !important; 
        }

        .custom-multiselect-wrapper .input-error {
          border-right: none !important; 
        }

        .form-feedback-box {
          padding: 1rem;
          border-radius: 0.375rem;
          border: 1px solid transparent;
          margin-bottom: 1rem;
          position: relative;
          opacity: 1;
          transition: opacity 0.15s linear;
        }
        .feedback-success {
          background-color: #d1e7dd;
          border-color: #badbcc;
          color: #0a3622;
        }
        .feedback-danger {
          background-color: #f8d7da;
          border-color: #f5c2c7;
          color: #58151c;
        }
        .feedback-close-btn {
          background: transparent;
          border: 0;
          font-size: 1.5rem;
          font-weight: 700;
          line-height: 1;
          color: #000;
          opacity: 0.5;
          position: absolute;
          top: 0.5rem;
          right: 0.75rem;
          cursor: pointer;
        }
        .feedback-close-btn:hover {
          opacity: 0.75;
        }
        .feedback-close-btn::before {
          content: "×";
        }

        .loading-spinner {
          display: inline-block;
          width: 1rem;
          height: 1rem;
          vertical-align: text-bottom;
          border: 0.15em solid currentColor;
          border-right-color: transparent;
          border-radius: 50%;
          animation: 0.75s linear infinite spinner-border;
          margin-right: 0.5rem;
        }
        @keyframes spinner-border {
          to {
            transform: rotate(360deg);
          }
        }

        .error-message {
          color: #dc3545;
          font-size: 0.875em;
          margin-top: 0.25rem;
          display: block;
        }

        .multiselect-pill {
            display: inline-flex;
            align-items: center;
            background-color: #003366;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            margin: 2px;
            line-height: 1.2;
        }
        .multiselect-pill-remove {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            margin-left: 0.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .multiselect-pill-remove:hover {
            opacity: 0.75;
        }
        
        /* Controla a exibição do placeholder no multi-select */
        .multiselect-display:not(:has(.multiselect-pill)) .placeholder-text {
             display: inline-block;
        }
        .multiselect-display:has(.multiselect-pill) .placeholder-text {
            display: none;
        }
        .multiselect-display {
            min-height: 48px; /* Garante altura mínima para clique */
        }
        .multiselect-dropdown {
            max-height: 240px;
            overflow-y: auto;
        }
    </style>
    
</head>
<body class="bg-white text-gray-800">

    <header class="container mx-auto px-4 py-4 flex items-center justify-between md:py-6 max-w-5xl">
        <div>
            <!-- Adicionado fallback de imagem -->
            <img src="/logo.png" class="h-auto max-w-[180px] md:max-w-[240px]" alt="Logo da Unieuro" 
                 onerror="this.src='https://placehold.co/240x60/FFFFFF/003366?text=UNIEURO'; this.onerror=null;">
        </div>
        <div>
            <span class="text-sm md:text-base font-medium text-[#003366]">Clínica Psicológica</span>
        </div>
    </header>

    <div class="bg-[#003366] text-white p-3 text-center font-bold text-base tracking-wider uppercase md:text-xl md:p-4">
        FICHA DE INSCRIÇÃO COMUNIDADE
    </div>

    <main class="container mx-auto px-3 md:px-4 pb-8 md:pb-16 max-w-5xl">
        
        <!-- Local para exibir mensagens de sucesso ou erro -->
        <div id="form-feedback" class="mt-4 w-full" aria-live="polite"></div>

        <form id="form-comunidade" method="POST" action="/formulario/cadastro/comunidade/" novalidate>
            
            <!-- Token CSRF (importante para segurança com Django) -->
            <input type="hidden" name="csrfmiddlewaretoken" value="TOKEN_GERADO_PELO_DJANGO_AQUI">

            <!-- Seção Tipo de Encaminhamento ADICIONADA -->
            <h3 class="font-bold text-lg text-gray-900 mt-6 mb-4 md:text-xl md:mt-8 md:mb-6">Convênio</h3>
            <div class="flex flex-wrap -mx-3">
                <div class="w-full md:w-1/2 px-3">
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="tipo_encaminhamento" class="sr-only">Tipo de Encaminhamento</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="tipo_encaminhamento" name="tipo_encaminhamento" required>
                            <option value="" selected disabled>Tipo de Encaminhamento</option>
                            <option value="caps">CAPS - Centro de Atenção Psicossocial</option>
                            <option value="cras">CRAS - Centro de Referência de Assistência Social</option>
                            <option value="creas">CREAS - Centro de Referência Especializado de Assistência Social</option>
                            <option value="deam">DEAM - Delegacia da Mulher</option>
                            <option value="dpdf">DPDF - Defensoria Pública do Distrito Federal</option>
                            <option value="mpdft">MPDFT - Ministério Público do Distrito Federal</option>
                            <option value="ses">SES - Secretaria de Saúde</option>
                            <option value="sejus">SEJUS - Secretaria de Justiça</option>
                            <option value="ubs">UBS - Unidade Básica de Saúde</option>
                            <option value="clinica_ana_lucia">Clínica Ana Lucia Chaves Fecury (Unieuro Asa Sul)</option>
                            <option value="outros">Outros</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                </div>
                <!-- Coluna da direita vazia para manter o alinhamento -->
                <div class="w-full md:w-1/2 px-3">
                </div>
            </div>
            <!-- Fim da Seção Adicionada -->

            <h3 class="font-bold text-lg text-gray-900 mt-6 mb-4 md:text-xl md:mt-8 md:mb-6">Dados Pessoais do Inscrito</h3>
            <div class="flex flex-wrap -mx-3">
                
                <!-- Coluna da Esquerda -->
                <div class="w-full md:w-1/2 px-3">
                    <div class="mb-4">
                        <label for="nome_inscrito" class="sr-only">Nome Completo</label>
                        <input type="text" id="nome_inscrito" name="nome_inscrito" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" required autocomplete="name">
                    </div>
                    <div class="mb-4">
                        <label for="data_nascimento" class="sr-only">Data de Nascimento</label>
                        <input type="date" class="form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" id="data_nascimento" name="data_nascimento" required autocomplete="bday">
                    </div>
                    <div class="mb-4">
                        <label for="cpf_inscrito" class="sr-only">CPF</label>
                        <input type="text" id="cpf_inscrito" name="cpf_inscrito" class="cpf form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="CPF" required maxlength="14" autocomplete="off">
                    </div>
                    <div class="mb-4">
                        <label for="telefone_inscrito" class="sr-only">Telefone Celular</label>
                        <input type="text" id="telefone_inscrito" name="telefone_inscrito" class="telefone form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" required maxlength="15" autocomplete="tel">
                    </div>
                    <div class="mb-4">
                        <label for="email_inscrito" class="sr-only">E-mail</label>
                        <input type="email" class="form-control email block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" id="email_inscrito" name="email_inscrito" placeholder="E-mail" required autocomplete="email">
                    </div>
                    
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="identidade_genero" class="sr-only">Identidade de Gênero</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="identidade_genero" name="identidade_genero" required>
                            <option value="" selected disabled>Identidade de Gênero</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                            <option value="naobinario">Não-binário</option>
                            <option value="transgenero">Transgênero</option>
                            <option value="outro">Outro</option>
                            <option value="pref-nao-dizer">Prefiro não dizer</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="cor_etnia" class="sr-only">Cor e Etnia</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="cor_etnia" name="cor_etnia" required>
                            <option value="" selected disabled>Cor e Etnia</option>
                            <option value="branca">Branca</option>
                            <option value="preta">Preta</option>
                            <option value="parda">Parda</option>
                            <option value="amarela">Amarela</option>
                            <option value="indigena">Indígena</option>
                            <option value="outra">Outra</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="religiao" class="sr-only">Religião</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="religiao" name="religiao" required>
                            <option value="" selected disabled>Religião</option>
                            <option value="catolica">Católica</option>
                            <option value="evangelica">Evangélica</option>
                            <option value="budismo">Budismo</option>
                            <option value="espirita">Espírita</option>
                            <option value="hinduismo">Hinduísmo</option>
                            <option value="islamismo">Islamismo</option>
                            <option value="judaismo">Judaísmo</option>
                            <option value="matriz-afro">Religião de Matriz Africana</option>
                            <option value="outra">Outra</option>
                            <option value="nenhuma">Nenhuma / Agnóstico / Ateu</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="estado_civil_inscrito" class="sr-only">Estado Civil</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="estado_civil_inscrito" name="estado_civil_inscrito" required>
                            <option value="" selected disabled>Estado Civil</option>
                            <option value="solteiro">Solteiro(a)</option>
                            <option value="casado">Casado(a)</option>
                            <option value="divorciado">Divorciado(a)</option>
                            <option value="viuvo">Viúvo(a)</option>
                            <option value="uniao-estavel">União Estável</option>
                            <option value="nenhum">Nenhum</option>
                            <option value="outros">Outros</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    
                    <!-- Este select será substituído pelo JS -->
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="motivos_acompanhamento" class="sr-only">Motivos da Busca do Tratamento/Acompanhamento Psicológico</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="motivos_acompanhamento" name="motivos_acompanhamento" required>
                            <option value="" selected disabled>Motivos da Busca do Tratamento/Acompanhamento Psicológico</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                </div>

                <!-- Coluna da Direita -->
                <div class="w-full md:w-1/2 px-3">
                    
                    <!-- Este select será substituído pelo JS -->
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="medicamentos_usados" class="sr-only">Uso de Medicação</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="medicamentos_usados" name="medicamentos_usados" required>
                            <option value="" selected disabled>Uso de Medicação</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    
                    <!-- Este select será substituído pelo JS -->
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="pcd_neurodivergente" class="sr-only">Pessoa com Deficiência e/ou Neurodivergências</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="pcd_neurodivergente" name="pcd_neurodivergente" required>
                            <option value="" selected disabled>Pessoa com Deficiência e/ou Neurodivergências</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>

                    <!-- Este select será substituído pelo JS -->
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="doencas_fisicas" class="sr-only">Doenças Físicas Diagnosticadas</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="doencas_fisicas" name="doencas_fisicas" required>
                            <option value="" selected disabled>Doenças Físicas Diagnosticadas</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="tipo_terapias" class="sr-only">Tipo de Terapia</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="tipo_terapias" name="tipo_terapias" required>
                            <option value="" selected disabled>Tipo de Terapia</option>
                            <option value="individual">Individual</option>
                            <option value="grupo">Grupo</option>
                            <option value="casal">Casal</option>
                            <option value="familia">Família</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="disponibilidade" class="sr-only">Disponibilidade</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="disponibilidade" name="disponibilidade" required>
                            <option value="" selected disabled>Disponibilidade</option>
                            <option value="manha_semana">Manhã (Segunda a Sexta)</option>
                            <option value="tarde_semana">Tarde (Segunda a Sexta)</option>
                            <option value="noite_semana">Noite (Segunda a Sexta)</option>
                            <option value="sabado_manha">Sábado (Somente pela manhã, 8:30h às 12h)</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    <div class="mb-4">
                        <label for="rua" class="sr-only">Rua</label>
                        <input type="text" id="rua" name="rua" class="form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Rua" required autocomplete="address-line1">
                    </div>
                    <div class="mb-4">
                        <label for="bairro" class="sr-only">Bairro</label>
                        <input type="text" id="bairro" name="bairro" class="form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Bairro" required autocomplete="address-level2">
                    </div>
                    <div class="mb-4">
                        <label for="cidade" class="sr-only">Cidade</label>
                        <input type="text" id="cidade" name="cidade" class="form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Cidade" required autocomplete="address-level2">
                    </div>
                    <div class="custom-select-wrapper relative mb-4">
                        <label for="uf" class="sr-only">UF</label>
                        <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="uf" name="uf" required autocomplete="address-level1">
                            <option value="" selected disabled>UF</option>
                            <option value="DF">Distrito Federal</option>
                        </select>
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                    </div>
                    <div class="mb-4">
                        <label for="cep" class="sr-only">CEP</label>
                        <input type="text" id="cep" name="cep" class="form-control cep block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="CEP" required maxlength="9" autocomplete="postal-code">
                    </div>
                </div>
            </div>

            <!-- Checkbox Menor de Idade -->
            <div class="flex flex-wrap -mx-3">
                <div class="w-full px-3">
                    <div class="flex items-center gap-3 mt-6">
                        <label class="font-bold text-base md:text-lg order-1 text-gray-800 cursor-pointer" for="checkMenorIdade">
                            O Inscrito é menor de idade?
                        </label>
                        <input class="order-2 w-5 h-5 m-0 border border-gray-300 bg-gray-100 rounded focus:ring-offset-0 focus:ring-2 focus:ring-[#003366] checked:bg-[#003366] checked:border-[#003366] cursor-pointer md:w-6 md:h-6" type="checkbox" id="checkMenorIdade" name="menorIdade">
                    </div>
                </div>
            </div>

            <!-- Seção do Responsável (Oculta por padrão) -->
            <div id="dadosResponsavel" class="hidden">
                <h3 class="font-bold text-lg text-gray-900 mt-6 mb-4 md:text-xl md:mt-8 md:mb-6">Dados do Responsável Legal</h3>
                <div class="flex flex-wrap -mx-3" id="secao-responsavel">
                    <div class="w-full md:w-1/2 px-3">
                        <div class="mb-4">
                            <label for="nome_responsavel" class="sr-only">Nome Completo do Responsável</label>
                            <input type="text" id="nome_responsavel" name="nome_responsavel" class="form-control apenas-letras block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" autocomplete="name">
                        </div>
                        <div class="mb-4">
                             <label for="cpf_responsavel" class="sr-only">CPF do Responsável</label>
                            <input type="text" id="cpf_responsavel" name="cpf_responsavel" class="form-control cpf block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="CPF" maxlength="14" autocomplete="off">
                        </div>
                        <div class="mb-4">
                            <label for="telefone_responsavel" class="sr-only">Telefone Celular do Responsável</label>
                            <input type="text" id="telefone_responsavel" name="telefone_responsavel" class="form-control telefone block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" maxlength="15" autocomplete="tel">
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 px-3">
                        <div class="mb-4">
                            <label for="email_responsavel" class="sr-only">E-mail do Responsável</label>
                            <input type="email" id="email_responsavel" class="form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" name="email_responsavel" placeholder="E-mail" autocomplete="email">
                        </div>
                        <div class="custom-select-wrapper relative mb-4">
                            <label for="estado_civil_responsavel" class="sr-only">Estado Civil do Responsável</label>
                            <select class="form-select block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base appearance-none pr-12" id="estado_civil_responsavel" name="estado_civil_responsavel">
                                <option value="" selected disabled>Estado Civil</option>
                                <option value="solteiro">Solteiro(a)</option>
                                <option value="casado">Casado(a)</option>
                                <option value="divorciado">Divorciado(a)</option>
                                <option value="viuvo">Viúvo(a)</option>
                                <option value="uniao-estavel">União Estável</option>
                            </select>
                            <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12"><i class="bi bi-caret-down-fill" aria-hidden="true"></i></div>
                        </div>
                        <div class="mb-4">
                            <label for="parentesco_responsavel" class="sr-only">Grau de Parentesco</label>
                            <input type="text" id="parentesco_responsavel" name="parentesco_responsavel" class="form-control apenas-letras block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Grau de Parentesco">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contatos de Urgência -->
            <h3 class="font-bold text-lg text-gray-900 mt-6 mb-4 md:text-xl md:mt-8 md:mb-6">Contato(s) de Urgência</h3>
            <div id="emergencyContactsContainer">
                <!-- Contato 1 (Base) -->
                <div class="contact-entry relative p-4 md:p-6 bg-gray-50 border border-gray-200 rounded-md mt-4"> 
                    <div class="flex flex-wrap -mx-3">
                        <h5 class="w-full px-3 font-bold text-base mt-0 mb-2 text-[#003366]">Contato 1</h5>
                        <div class="w-full md:w-1/2 px-3">
                            <div class="mb-4 md:mb-0">
                                <label for="nome_urgencia_1" class="sr-only">Nome Completo (Urgência)</label>
                                <input type="text" id="nome_urgencia_1" name="nome_urgencia[]" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" required>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 px-3">
                             <div class="mb-0">
                                <label for="telefone_urgencia_1" class="sr-only">Telefone Celular (Urgência)</label>
                                <input type="text" id="telefone_urgencia_1" name="telefone_urgencia[]" class="telefone form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" required maxlength="15">
                            </div>
                        </div>
                    </div>
                    <!-- Botão de remover não existe para o primeiro contato -->
                </div>
            </div>
            
            <div class="flex items-center gap-2 mt-4 mb-4">
                 <button type="button" class="add-contact-btn bg-[#003366] text-white border-none rounded-full w-8 h-8 text-lg flex items-center justify-center leading-none shadow-md transition-all duration-200 ease-in-out hover:bg-[#004a99] hover:scale-110" id="addContactBtn" aria-label="Adicionar outro contato de urgência">
                     <i class="bi bi-plus" aria-hidden="true"></i>
                 </button>
                 <span class="text-sm font-medium text-gray-700">Adicionar outro contato</span>
            </div>

            <!-- Seção LGPD -->
            <div class="bg-gray-100 border border-gray-200 p-4 md:p-6 mt-8 rounded-md">
                <p class="text-sm leading-relaxed text-gray-800 mb-4 font-bold">
                    Ao preencher o presente formulário e submeter minha inscrição para atendimento na Clínica Escola de Psicologia do Unieuro, declaro que autorizo, em conformidade com o inciso I do art. 7, da Lei nº 13.709/2018 (Lei Geral de Proteção de Dados Pessoais – LGPD) que os dados pessoais aqui fornecidos sejam tratados e utilizados unicamente para a finalidade exclusiva de compor o banco de dados dos atendimentos a serem realizados sendo a ciência, o tratamento e o uso destes restrito aos membros da Clínica Escola de Psicologia, nos termos da LGPD.
                </p>
                <p class="text-sm leading-relaxed text-gray-800 mb-4 font-bold">
                    Declaro ainda que tenho conhecimento de que a revogação da presente autorização poderá ser feita a qualquer momento, mediante solicitação formal a ser registrada pelo e-mail: psicologia@unieuro.edu.br
                </p>
                <div class="flex items-center gap-2 mt-6">
                    <label class="font-bold text-base md:text-lg text-gray-800 cursor-pointer" for="checkLGPD">
                        De Acordo
                    </label>
                    <input class="w-4 h-4 m-0 border-gray-400 rounded text-[#003366] focus:ring-2 focus:ring-offset-0 focus:ring-[#003366] cursor-pointer" type="checkbox" id="checkLGPD" name="deAcordo" required>
                </div>
            </div>

            <!-- Botão de Envio -->
            <div class="flex flex-wrap -mx-3 mt-12">
                <div class="w-full px-3 text-center">
                    <button type="submit" class="w-full bg-[#004a99] text-white border-none font-bold uppercase tracking-wide py-3 px-6 text-sm rounded-md transition-all duration-200 ease-in-out hover:bg-[#005cb3] hover:shadow-lg disabled:bg-[#004a99] disabled:opacity-70 disabled:cursor-wait md:w-auto md:min-w-[220px]" id="submit-button">
                        Salvar Inscrição
                    </button>
                </div>
            </div>

        </form>
    </main>

    <footer class="text-center py-8">
        <p class="text-sm text-gray-500">
            © 2023 Clínica de Psicologia. Todos os direitos reservados.
        </p>
    </footer>
    
    <!-- JavaScript Embutido -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const form = document.getElementById('form-comunidade');
            if (!form) {
                console.error("Erro Crítico: O formulário com ID 'form-comunidade' não foi encontrado.");
                return;
            }

            // --- Referências ---
            const submitButton = document.getElementById('submit-button');
            const formFeedback = document.getElementById('form-feedback');
            // ------------------------

            const csrfTokenInput = form.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenInput || !csrfTokenInput.value) {
                console.warn('Input CSRF token não encontrado ou vazio. O envio para o Django falhará.');
            }
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

            const checkMenor = document.getElementById('checkMenorIdade');
            const dadosResponsavel = document.getElementById('dadosResponsavel');
            const inputsResponsavel = dadosResponsavel.querySelectorAll('input, select');

            function toggleResponsavel() {
                const isChecked = checkMenor.checked;
                // Usa classes 'hidden' e 'block' do Tailwind
                if (isChecked) {
                    dadosResponsavel.classList.remove('hidden');
                    dadosResponsavel.classList.add('block');
                } else {
                    dadosResponsavel.classList.remove('block');
                    dadosResponsavel.classList.add('hidden');
                }

                inputsResponsavel.forEach(input => {
                    input.required = isChecked;
                    if (!isChecked) {
                        input.value = '';
                        if (input.tagName === 'SELECT') {
                            updateSelectColor(input);
                        }
                        input.classList.remove('input-error');
                        // Encontra o parente mais próximo que contém o campo
                        const parent = input.closest('.mb-4') || input.closest('.custom-select-wrapper');
                        const errorMsg = parent ? parent.querySelector('.error-message') : null;
                        if (errorMsg) errorMsg.remove();
                    }
                });
            }

            checkMenor.addEventListener('change', toggleResponsavel);
            toggleResponsavel(); // Executa ao carregar a página

            /**
             * Atualiza a cor do texto de um <select> com base se 
             * a opção "placeholder" (value="") está selecionada.
             */
            function updateSelectColor(select) {
                if (select.value === "") {
                    select.style.color = '#6c757d'; // Cor do placeholder
                } else {
                    select.style.color = '#333'; // Cor do texto
                }
            }

            // Aplica a lógica de cor aos selects normais (não-multiplos)
            document.querySelectorAll('.form-select:not([multiple])').forEach(select => {
                select.addEventListener('change', () => updateSelectColor(select));
                updateSelectColor(select);
            });

            const contactsContainer = document.getElementById('emergencyContactsContainer');
            const addContactBtn = document.getElementById('addContactBtn');
            let contactCount = 1;

            addContactBtn.addEventListener('click', function () {
                contactCount++;
                const newContact = document.createElement('div');
                // Adiciona classes do Tailwind para o novo 'contact-entry'
                newContact.className = 'contact-entry relative p-4 md:p-6 bg-gray-50 border border-gray-200 rounded-md mt-4';
                newContact.innerHTML = `
                        <div class="flex flex-wrap -mx-3">
                            <h5 class="w-full px-3 font-bold text-base mt-0 mb-2 text-[#003366]">Contato ${contactCount}</h5>
                            <div class="w-full md:w-1/2 px-3">
                                <div class="mb-4 md:mb-0">
                                    <label for="nome_urgencia_${contactCount}" class="sr-only">Nome Completo Contato ${contactCount}</label>
                                    <input type="text" id="nome_urgencia_${contactCount}" name="nome_urgencia[]" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" required>
                                </div>
                            </div>
                            <div class="w-full md:w-1/2 px-3">
                                <div class="mb-0">
                                    <label for="telefone_urgencia_${contactCount}" class="sr-only">Telefone Celular Contato ${contactCount}</label>
                                    <input type="text" id="telefone_urgencia_${contactCount}" name="telefone_urgencia[]" class="telefone form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" required maxlength="15">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="remove-contact-btn absolute top-2.5 right-2.5 bg-red-600 text-white border-none rounded-full w-8 h-8 text-lg flex items-center justify-center leading-none shadow-md transition-all duration-200 ease-in-out hover:bg-red-700 hover:scale-110" aria-label="Remover Contato ${contactCount}"><i class="bi bi-dash" aria-hidden="true"></i></button>
                    `;
                contactsContainer.appendChild(newContact);

                // Adiciona formatação de máscara aos novos campos
                newContact.querySelectorAll('.telefone').forEach(input => {
                    input.addEventListener('input', (e) => e.target.value = formatTelefone(e.target.value));
                });
                newContact.querySelectorAll('.apenas-letras').forEach(input => {
                    input.addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^\p{L}\s'-]/gu, ''));
                });
            });

            contactsContainer.addEventListener('click', function (e) {
                const removeBtn = e.target.closest('.remove-contact-btn');
                if (removeBtn) {
                    removeBtn.closest('.contact-entry').remove();
                    updateContactNumbers();
                }
            });

            function updateContactNumbers() {
                const allContacts = contactsContainer.querySelectorAll('.contact-entry');
                allContacts.forEach((contact, index) => {
                    const title = contact.querySelector('h5');
                    if (title) title.textContent = `Contato ${index + 1}`;

                    const removeBtn = contact.querySelector('.remove-contact-btn');
                    if (removeBtn) removeBtn.setAttribute('aria-label', `Remover Contato ${index + 1}`);

                    const nomeInput = contact.querySelector('input[name="nome_urgencia[]"]');
                    const nomeLabel = contact.querySelector(`label[for^="nome_urgencia_"]`);
                    if (nomeInput) nomeInput.id = `nome_urgencia_${index + 1}`;
                    if (nomeLabel) nomeLabel.setAttribute('for', `nome_urgencia_${index + 1}`);

                    const telInput = contact.querySelector('input[name="telefone_urgencia[]"]');
                    const telLabel = contact.querySelector(`label[for^="telefone_urgencia_"]`);
                    if (telInput) telInput.id = `telefone_urgencia_${index + 1}`;
                    if (telLabel) telLabel.setAttribute('for', `telefone_urgencia_${index + 1}`);
                });
                contactCount = allContacts.length;
            }

            /**
             * Exibe uma mensagem de feedback no topo do formulário.
             * @param {'success' | 'danger'} type - O tipo de alerta.
             * @param {string} message - A mensagem HTML para exibir.
             */
            function showMessage(type, message) {
                const alertDiv = document.createElement('div');
                // Usa as novas classes CSS personalizadas
                alertDiv.className = `form-feedback-box feedback-${type}`;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                            ${message}
                            <button type="button" class="feedback-close-btn" aria-label="Close"></button>
                        `;

                formFeedback.innerHTML = ''; // Limpa mensagens antigas
                formFeedback.appendChild(alertDiv);

                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // --- NOVO: Listener para fechar os alertas customizados ---
            formFeedback.addEventListener('click', function (e) {
                const closeButton = e.target.closest('.feedback-close-btn');
                if (closeButton) {
                    const alertBox = closeButton.closest('.form-feedback-box');
                    // Adiciona um efeito de fade out simples
                    alertBox.style.opacity = '0';
                    setTimeout(() => alertBox.remove(), 150);
                }
            });


            // --- INÍCIO LÓGICA MULTI-SELECT ---

            // Define as opções para os campos multi-select
            // (As opções foram removidas do HTML para serem gerenciadas aqui)
            const multiSelectOptions = {
                'motivos_acompanhamento': [
                    { value: "ansiedade", text: "Ansiedade" },
                    { value: "assediomoral", text: "Assédio Moral" },
                    { value: "depressao", text: "Depressão" },
                    { value: "dfaprendizagem", text: "Dificuldade de Aprendizagem" },
                    { value: "humorinstavel", text: "Humor Instável" },
                    { value: "insonia", text: "Insônia" },
                    { value: "isolasocial", text: "Isolamento Social" },
                    { value: "luto", text: "Luto" },
                    { value: "tristeza", text: "Tristeza" },
                    { value: "apatia", text: "Apatia" },
                    { value: "exaustao", text: "Exaustão" },
                    { value: "fadiga", text: "Fadiga" },
                    { value: "faltanimo", text: "Falta Ânimo" },
                    { value: "assediosexual", text: "Assédio Sexual" },
                    { value: "outro", text: "Outro" }
                ],
                'medicamentos_usados': [
                    { value: "ansiolitico", text: "Ansiolítico" },
                    { value: "antidepressivo", text: "Antidepressivo" },
                    { value: "antipsicotico", text: "Antipsicótico" },
                    { value: "estabhumor", text: "Estabilizador de Humor" },
                    { value: "memoriatct", text: "Medicamentos para memória, atenção e concentração" },
                    { value: "nenhum", text: "Nenhum" },
                    { value: "outro", text: "Outro" }
                ],
                'pcd_neurodivergente': [
                    { value: "tea", text: "TEA (Transtorno do Espectro Autista)" },
                    { value: "tdah", text: "TDAH (Transtorno do Déficit de Atenção com Hiperatividade)" },
                    { value: "def_fisica", text: "Deficiência Física" },
                    { value: "def_visual", text: "Deficiência Visual" },
                    { value: "def_auditiva", text: "Deficiência Auditiva" },
                    { value: "transtorno_aprendizagem", text: "Transtornos de Aprendizagem (Dislexia, etc.)" },
                    { value: "altas_habilidades", text: "Altas Habilidades / Superdotação" },
                    { value: "nenhum", text: "Nenhum" },
                    { value: "outro", text: "Outro" }
                ],
                'doencas_fisicas': [
                    { value: "doencaresp", text: "Doenças respiratórias" },
                    { value: "cancer", text: "Câncer" },
                    { value: "diabete", text: "Diabetes" },
                    { value: "disfusexul", text: "Disfunções sexuais" },
                    { value: "doencadgt", text: "Doenças degenerativas" },
                    { value: "escleorosemlt", text: "Esclerose múltipla" },
                    { value: "hcpt", text: "Hipertensão ou cardiopatias" },
                    { value: "luposatm", text: "Lúpus ou outras doenças autoimunes" },
                    { value: "obesidade", text: "Obesidade" },
                    { value: "pblmarenal", text: "Problemas renais" },
                    { value: "nenhum", text: "Nenhum" },
                    { value: "outro", text: "Outro" }
                ]
            };

            // Estado para rastrear seleções (ex: { motivos_acompanhamento: ['ansiedade', 'luto'] })
            const multiSelectState = {};

            /**
             * Inicializa todos os componentes multi-select no formulário.
             */
            function initializeMultiSelects() {
                Object.keys(multiSelectOptions).forEach(fieldId => {
                    const originalSelect = document.getElementById(fieldId);
                    if (!originalSelect) {
                         console.warn(`Campo select original com ID '${fieldId}' não encontrado para multi-select.`);
                         return;
                    }

                    const placeholder = originalSelect.querySelector('option[disabled]')?.textContent || 'Selecione uma ou mais opções';
                    const options = multiSelectOptions[fieldId];
                    
                    // Inicializa o estado
                    multiSelectState[fieldId] = [];

                    // Cria o novo componente HTML
                    const multiSelectWrapper = document.createElement('div');
                    multiSelectWrapper.className = 'custom-multiselect-wrapper relative mb-4';
                    multiSelectWrapper.dataset.fieldId = fieldId;

                    multiSelectWrapper.innerHTML = `
                        <label for="${fieldId}_display" class="sr-only">${placeholder}</label>
                        
                        <!-- Div que exibe as pills e o placeholder -->
                        <div id="${fieldId}_display" name="${fieldId}_display" class="multiselect-display form-control flex items-center flex-wrap gap-1 block w-full bg-gray-100 border-none rounded-l-md py-2 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base cursor-pointer pr-12" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false">
                            <span class="placeholder-text text-gray-500">${placeholder}</span>
                        </div>

                        <!-- Seta azul (igual aos outros selects) -->
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>

                        <!-- Dropdown com as opções -->
                        <div class="multiselect-dropdown absolute hidden top-full left-0 right-0 z-10 bg-white border border-gray-300 rounded-md shadow-lg mt-1" role="listbox">
                            ${options.map(option => `
                                <div class="multiselect-option flex items-center p-2 hover:bg-gray-100 cursor-pointer" data-value="${option.value}" role="option" aria-selected="false">
                                    <input type="checkbox" class="w-4 h-4 text-[#003366] rounded border-gray-300 focus:ring-[#003366] mr-2 pointer-events-none" tabindex="-1">
                                    <span>${option.text}</span>
                                </div>
                            `).join('')}
                        </div>
                        <!-- Input oculto que armazena os valores (ex: "ansiedade,luto") -->
                        <input type="hidden" id="${fieldId}" name="${fieldId}" class="multiselect-hidden-input">
                    `;

                    // Substitui o select original pelo novo componente
                    originalSelect.closest('.custom-select-wrapper').replaceWith(multiSelectWrapper);

                    // --- Adiciona Event Listeners para o novo componente ---
                    const display = multiSelectWrapper.querySelector('.multiselect-display');
                    const dropdown = multiSelectWrapper.querySelector('.multiselect-dropdown');
                    const optionsElements = multiSelectWrapper.querySelectorAll('.multiselect-option');

                    // Abrir/Fechar dropdown
                    display.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isExpanded = dropdown.classList.contains('hidden');
                        closeAllMultiSelects(); // Fecha todos os outros
                        if (isExpanded) {
                            dropdown.classList.remove('hidden');
                            display.setAttribute('aria-expanded', 'true');
                        } else {
                            dropdown.classList.add('hidden');
                            display.setAttribute('aria-expanded', 'false');
                        }
                    });

                    // Selecionar/Deselecionar opção
                    optionsElements.forEach(optionEl => {
                        optionEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const value = optionEl.dataset.value;
                            toggleMultiSelectOption(fieldId, value);
                        });
                    });
                });
            }

            /**
             * Fecha todos os dropdowns multi-select abertos.
             */
            function closeAllMultiSelects() {
                document.querySelectorAll('.multiselect-dropdown').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                    // Tenta encontrar o display (elemento anterior ou o wrapper .custom-arrow)
                    let display = dropdown.previousElementSibling;
                    if (display.classList.contains('custom-arrow')) {
                        display = display.previousElementSibling;
                    }
                    
                    if (display && display.classList.contains('multiselect-display')) {
                         display.setAttribute('aria-expanded', 'false');
                    }
                });
            }


            /**
             * Alterna o estado de uma opção multi-select.
             * @param {string} fieldId - O ID do campo (ex: 'motivos_acompanhamento').
             * @param {string} value - O valor da opção clicada.
             */
            function toggleMultiSelectOption(fieldId, value) {
                const state = multiSelectState[fieldId];
                if (!state) return;
                
                const index = state.indexOf(value);

                if (index > -1) {
                    state.splice(index, 1); // Remove
                } else {
                    state.push(value); // Adiciona
                }

                updateMultiSelectUI(fieldId);
            }

            /**
             * Atualiza a UI (pills e input oculto) de um campo multi-select.
             * @param {string} fieldId - O ID do campo a ser atualizado.
             */
            function updateMultiSelectUI(fieldId) {
                const wrapper = document.querySelector(`.custom-multiselect-wrapper[data-field-id="${fieldId}"]`);
                if (!wrapper) return;

                const display = wrapper.querySelector('.multiselect-display');
                const hiddenInput = wrapper.querySelector('.multiselect-hidden-input');
                const placeholder = display.querySelector('.placeholder-text');
                const options = multiSelectOptions[fieldId];
                const state = multiSelectState[fieldId];

                // 1. Limpa pills antigos
                display.querySelectorAll('.multiselect-pill').forEach(pill => pill.remove());

                // 2. Adiciona pills novos
                state.forEach(value => {
                    const option = options.find(o => o.value === value);
                    if (!option) return;

                    const pill = document.createElement('span');
                    pill.className = 'multiselect-pill';
                    pill.dataset.value = value;
                    pill.innerHTML = `
                        <span>${option.text}</span>
                        <button type="button" class="multiselect-pill-remove" aria-label="Remover ${option.text}">&times;</button>
                    `;
                    
                    // Adiciona o pill antes do placeholder
                    display.insertBefore(pill, placeholder);
                });

                // 3. Atualiza o input oculto
                hiddenInput.value = state.join(','); // Envia como string separada por vírgula

                // 4. Atualiza o estado dos checkboxes no dropdown
                wrapper.querySelectorAll('.multiselect-option').forEach(optionEl => {
                    const value = optionEl.dataset.value;
                    const checkbox = optionEl.querySelector('input[type="checkbox"]');
                    if (state.includes(value)) {
                        checkbox.checked = true;
                        optionEl.setAttribute('aria-selected', 'true');
                    } else {
                        checkbox.checked = false;
                        optionEl.setAttribute('aria-selected', 'false');
                    }
                });

                   // 5. Limpa erro se o usuário selecionar algo
                   if (state.length > 0) {
                       clearMultiSelectError(fieldId);
                   }
            }
            
            /** Limpa o erro de um campo multi-select específico */
            function clearMultiSelectError(fieldId) {
                 const wrapper = document.querySelector(`.custom-multiselect-wrapper[data-field-id="${fieldId}"]`);
                 if (!wrapper) return;
                 const display = wrapper.querySelector('.multiselect-display');
                 
                 if (display.classList.contains('input-error')) {
                     display.classList.remove('input-error');
                     const errorMsg = wrapper.querySelector('.error-message');
                     if (errorMsg) errorMsg.remove();
                 }
            }

            // --- Event Listeners Globais do Multi-Select ---

            // Clica para remover um pill
            form.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.multiselect-pill-remove');
                if (removeBtn) {
                    e.preventDefault(); // Impede o clique de fechar o dropdown
                    e.stopPropagation(); // Impede o clique de fechar o dropdown
                    const pill = removeBtn.closest('.multiselect-pill');
                    const wrapper = removeBtn.closest('.custom-multiselect-wrapper');
                    const fieldId = wrapper.dataset.fieldId;
                    const value = pill.dataset.value;
                    
                    toggleMultiSelectOption(fieldId, value);
                }
            });

            // Clica fora para fechar
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-multiselect-wrapper')) {
                    closeAllMultiSelects();
                }
            });

            // Inicializa os componentes
            initializeMultiSelects();

            // --- FIM LÓGICA MULTI-SELECT ---


            /** Limpa todos os erros de validação da tela. */
            function clearErrors() {
                form.querySelectorAll('.error-message').forEach(el => el.remove());
                form.querySelectorAll('.input-error').forEach(el => {
                    el.classList.remove('input-error');
                });
                formFeedback.innerHTML = '';
            }

            /**
             * Exibe erros de validação do backend nos campos correspondentes.
             * @param {Object} erros - Um objeto onde a chave é o 'id' do campo e o valor é um array de mensagens.
             */
            function displayErrors(erros) {
                console.log("Erros de validação:", erros);

                let firstErrorField = null;

                for (const [fieldName, errorMessages] of Object.entries(erros)) {
                    let campo = document.getElementById(fieldName);

                    // --- AJUSTE MULTI-SELECT ---
                    // Se o ID for de um display (ex: "motivos_acompanhamento_display")
                    if (!campo && fieldName.endsWith('_display')) {
                        campo = document.getElementById(fieldName);
                    }
                    // --- FIM AJUSTE ---

                    if (!campo && fieldName.includes('[]')) {
                        // Tenta encontrar campos de array (ex: nome_urgencia[])
                        const camposArray = form.querySelectorAll(`[name="${fieldName}"]`);
                        if (camposArray.length > 0) campo = camposArray[0]; // Pega o primeiro, por exemplo
                    } else if (!campo) {
                        // Tenta encontrar por 'name' se 'id' falhar
                        campo = form.querySelector(`[name="${fieldName}"]`);
                    }

                    if (campo) {
                        if (!firstErrorField) firstErrorField = campo;

                        // --- AJUSTE MULTI-SELECT ---
                        // O 'campo' é o display, mas o 'parentWrapper' é o wrapper principal
                        let parentWrapper;
                        if (campo.classList.contains('multiselect-display')) {
                            campo.classList.add('input-error');
                            parentWrapper = campo.closest('.custom-multiselect-wrapper');
                        } else {
                            campo.classList.add('input-error');
                            parentWrapper = campo.closest('.custom-select-wrapper') || campo.closest('.mb-4') || campo.parentNode;
                        }
                        // --- FIM AJUSTE ---

                        // Evita adicionar múltiplas mensagens de erro
                        if (parentWrapper.querySelector('.error-message')) continue;

                        const erroEl = document.createElement('span');
                        erroEl.className = 'error-message'; // Classe definida em comunidade.css
                        erroEl.textContent = Array.isArray(errorMessages) ? errorMessages.join(' ') : errorMessages;
                        
                        // Insere após o último elemento no wrapper
                        parentWrapper.appendChild(erroEl);

                    } else {
                        console.warn(`Campo de erro '${fieldName}' não encontrado no DOM.`);
                    }
                }

                // Se a mensagem de erro não for a geral, exibe a geral.
                if (!formFeedback.querySelector('.feedback-danger')) {
                     showMessage('danger', '<strong>Erro de validação:</strong> Por favor, verifique os campos destacados.');
                }

                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }


            // --- NOVO: Funções de Validação Client-Side ---

            /** Valida um email usando Regex. */
            function isValidEmail(email) {
                const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(String(email).toLowerCase());
            }

            /** Valida o comprimento de um CPF (apenas dígitos). */
            function isValidCPF(cpf) {
                const digits = cpf.replace(/\D/g, '');
                return digits.length === 11;
            }

            /** Valida o comprimento de um Telefone (10 ou 11 dígitos). */
            function isValidTelefone(tel) {
                const digits = tel.replace(/\D/g, '');
                return digits.length >= 10 && digits.length <= 11;
            }

            /** Valida o comprimento de um CEP (8 dígitos). */
            function isValidCEP(cep) {
                const digits = cep.replace(/\D/g, '');
                return digits.length === 8;
            }


            /**
             * --- NOVO: Função principal de validação client-side ---
             * @returns {boolean} - Retorna true se o formulário for válido, false caso contrário.
             */
            function validateForm() {
                clearErrors(); // Limpa erros antigos antes de validar
                const errors = {};
                
                // 1. Pega todos os campos 'required' que estão visíveis (ignora os da seção 'responsavel' se ocultos)
                const requiredFields = form.querySelectorAll('[required]');
                
                requiredFields.forEach(field => {
                    // Ignora campos dentro da seção de responsável oculta
                    if (field.closest('#dadosResponsavel') && dadosResponsavel.classList.contains('hidden')) {
                         return;
                    }
                     
                    const fieldId = field.id;
                    const fieldValue = field.value.trim();

                    // Checa campos vazios
                    if (field.tagName === 'SELECT' && fieldValue === '') {
                        errors[fieldId] = 'Este campo é obrigatório.';
                    } else if (field.tagName !== 'SELECT' && field.type !== 'checkbox' && fieldValue === '') {
                        errors[fieldId] = 'Este campo é obrigatório.';
                    }

                    // Checa formatos específicos (se não estiverem vazios)
                    else if (field.classList.contains('email') && !isValidEmail(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um e-mail válido.';
                    }
                    else if (field.classList.contains('cpf') && !isValidCPF(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um CPF válido (11 dígitos).';
                    }
                    else if (field.classList.contains('telefone') && !isValidTelefone(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um telefone válido (10 ou 11 dígitos).';
                    }
                    else if (field.classList.contains('cep') && !isValidCEP(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um CEP válido (8 dígitos).';
                    }
                });

                // --- NOVA VALIDAÇÃO MULTI-SELECT ---
                Object.keys(multiSelectOptions).forEach(fieldId => {
                    const wrapper = document.querySelector(`.custom-multiselect-wrapper[data-field-id="${fieldId}"]`);
                    if (!wrapper) return;
                    
                    const hiddenInput = document.getElementById(fieldId);
                    const display = wrapper.querySelector('.multiselect-display');
                    
                    // Assumindo que todos os campos convertidos são 'required'
                    if (hiddenInput.value.trim() === '') {
                         errors[display.id] = 'Este campo é obrigatório.'; // Usa o ID do display para o displayErrors
                    }
                });
                // --- FIM VALIDAÇÃO MULTI-SELECT ---

                // 2. Checa o Checkbox LGPD (que tem 'required' mas valor diferente)
                const checkLGPD = document.getElementById('checkLGPD');
                if (!checkLGPD.checked) {
                    errors[checkLGPD.id] = 'Você deve concordar com os termos.';
                }

                // 3. Processa os erros
                if (Object.keys(errors).length > 0) {
                    displayErrors(errors);
                    return false;
                }

                return true;
            }


            form.addEventListener('submit', async function (event) {
                event.preventDefault();

                // --- MELHORIA: Validação client-side antes do envio ---
                const isFormValid = validateForm();
                if (!isFormValid) {
                    return; // Para a execução se o formulário for inválido
                }
                // --- Fim da validação ---

                // --- Estado de Loading (usa nova classe de spinner) ---
                submitButton.disabled = true;
                submitButton.innerHTML = `
                        <span class="loading-spinner" role="status" aria-hidden="true"></span>
                        Enviando...
                    `;

                const formData = new FormData(form);
                const dadosObjeto = {};

                const keys = new Set();
                for (const key of formData.keys()) {
                    keys.add(key);
                }

                for (const key of keys) {
                    if (key === 'csrfmiddlewaretoken') continue;

                    // Ignora os campos multi-select aqui, eles serão tratados abaixo
                    if (multiSelectOptions.hasOwnProperty(key)) continue;

                    if (key.endsWith('[]')) {
                        const cleanKey = key.slice(0, -2);
                        dadosObjeto[cleanKey] = formData.getAll(key);
                    } else {
                        dadosObjeto[key] = formData.get(key);
                    }
                }

                // --- INSERÇÃO MULTI-SELECT ---
                // Pega os valores dos inputs ocultos e transforma em arrays
                Object.keys(multiSelectOptions).forEach(fieldId => {
                    const hiddenInput = document.getElementById(fieldId);
                    if (hiddenInput) {
                        // Envia como um array de strings
                        dadosObjeto[fieldId] = hiddenInput.value.split(',').filter(Boolean); // filter(Boolean) remove strings vazias
                    }
                });
                // --- FIM INSERÇÃO MULTI-SELECT ---

                dadosObjeto.menorIdade = checkMenor.checked;
                dadosObjeto.deAcordo = document.getElementById('checkLGPD').checked;

                console.log("Dados a serem enviados (JSON):", dadosObjeto);

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(dadosObjeto)
                    });

                    const resultado = await response.json();

                    if (response.ok) {
                        showMessage('success', `<strong>Sucesso!</strong> ${resultado.mensagem || 'Inscrição realizada com sucesso!'}`);

                        form.reset();
                        
                        // --- RESET MULTI-SELECT UI ---
                        Object.keys(multiSelectState).forEach(fieldId => {
                            multiSelectState[fieldId] = []; // Limpa o estado
                            updateMultiSelectUI(fieldId); // Atualiza a UI (remove pills, mostra placeholder)
                        });
                        // --- FIM RESET ---

                        document.querySelectorAll('.form-select').forEach(updateSelectColor);
                        toggleResponsavel();

                        const extraContacts = contactsContainer.querySelectorAll('.contact-entry:not(:first-child)');
                        extraContacts.forEach(contact => contact.remove());
                        updateContactNumbers();

                    } else if (resultado.status === 'erro_validacao') {
                        displayErrors(resultado.erros);
                    } else {
                        showMessage('danger', `Erro do servidor: ${resultado.mensagem || 'Erro desconhecido.'}`);
                    }

                } catch (error) {
                    console.error('Erro de comunicação:', error);
                    showMessage('danger', 'Ocorreu um erro de comunicação com o servidor. Tente novamente mais tarde.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Salvar Inscrição';
                }
            });

            // --- Funções de Formatação (Máscaras) ---

            function formatCPF(value) {
                const digits = value.replace(/\D/g, '').slice(0, 11);
                if (digits.length <= 3) return digits;
                if (digits.length <= 6) return digits.replace(/(\d{3})(\d)/, '$1.$2');
                if (digits.length <= 9) return digits.replace(/(\d{3})(\d{3})(\d)/, '$1.$2.$3');
                return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            }

            function formatTelefone(value) {
                const digits = value.replace(/\D/g, '').slice(0, 11);
                if (digits.length <= 2) return `(${digits}`; 
                if (digits.length <= 7) return digits.replace(/(\d{2})(\d)/, '($1) $2'); 
                if (digits.length <= 10) return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3'); // Fixo
                return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3'); // Celular
            }

            function formatCEP(value) {
                const digits = value.replace(/\D/g, '').slice(0, 8);
                if (digits.length <= 5) return digits;
                return digits.replace(/(\d{5})(\d{1,3})/, '$1-$2');
            }

            form.addEventListener('input', function (e) {
                const target = e.target;

                // Limpa erro ao digitar
                if (target.classList.contains('input-error')) {
                    target.classList.remove('input-error');
                    const parent = target.closest('.custom-select-wrapper') || target.closest('.mb-4') || target.parentNode;
                    const errorMsg = parent ? parent.querySelector('.error-message') : null;
                    if (errorMsg) errorMsg.remove();
                }

                // Aplica máscaras
                if (target.classList.contains('cpf')) {
                    target.value = formatCPF(target.value);
                }

                if (target.classList.contains('telefone')) {
                    target.value = formatTelefone(target.value);
                }

                if (target.classList.contains('cep')) {
                    target.value = formatCEP(target.value);
                }

                if (target.classList.contains('apenas-letras')) {
                    // --- MELHORIA: Permite letras, espaços, apóstrofos e hífens ---
                    // Unicode property \p{L} matches any letter from any language. 'u' flag is for unicode.
                    target.value = target.value.replace(/[^\p{L}\s'-]/gu, '');
                }
            });

            // Limpa erro ao mudar select (para os selects que sobraram)
            form.addEventListener('change', function (e) {
                const target = e.target;
                if (target.tagName === 'SELECT' && target.classList.contains('input-error')) {
                    target.classList.remove('input-error');
                    const errorMsg = target.closest('.custom-select-wrapper').querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                }
                 // Limpa erro do checkbox LGPD
                 if (target.id === 'checkLGPD' && target.classList.contains('input-error')) {
                    target.classList.remove('input-error');
                    const errorMsg = target.closest('div').querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                }
            });

        });
    </script>

</body>
</html>


<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Inscrição da Comunidade</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
          font-family: "Inter", sans-serif;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }

        /* Estilo para placeholder de select (quando value="") */
        .form-select:invalid {
          color: #6c757d;
        }
        .form-select option {
          color: #333;
        }

        .form-control[type="date"]:invalid,
        .form-control[type="date"]::placeholder {
          color: #6c757d;
          opacity: 1;
        }
        
        /* Define a cor do placeholder para o input de data vazio */
        .form-control[type="date"] {
            color: #6c757d;
        }
        /* Define a cor do texto quando uma data é selecionada */
        .form-control[type="date"]:valid {
            color: #333;
        }

        .input-error {
          border: 1px solid #dc3545 !important;
          box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
        }
        .custom-select-wrapper .input-error {
          border-right: none !important; 
        }

        .custom-multiselect-wrapper .input-error {
          border-right: none !important; 
        }

        .form-feedback-box {
          padding: 1rem;
          border-radius: 0.375rem; /* rounded-md */
          border: 1px solid transparent;
          margin-bottom: 1rem;
          position: relative;
          opacity: 1;
          transition: opacity 0.15s linear;
        }
        .feedback-success {
          background-color: #d1e7dd;
          border-color: #badbcc;
          color: #0a3622;
        }
        .feedback-danger {
          background-color: #f8d7da;
          border-color: #f5c2c7;
          color: #58151c;
        }
        .feedback-close-btn {
          background: transparent;
          border: 0;
          font-size: 1.5rem;
          font-weight: 700;
          line-height: 1;
          color: #000;
          opacity: 0.5;
          position: absolute;
          top: 0.5rem;
          right: 0.75rem;
          cursor: pointer;
        }
        .feedback-close-btn:hover {
          opacity: 0.75;
        }
        .feedback-close-btn::before {
          content: "×";
        }

        .loading-spinner {
          display: inline-block;
          width: 1rem;
          height: 1rem;
          vertical-align: text-bottom;
          border: 0.15em solid currentColor;
          border-right-color: transparent;
          border-radius: 50%;
          animation: 0.75s linear infinite spinner-border;
          margin-right: 0.5rem;
        }
        @keyframes spinner-border {
          to {
            transform: rotate(360deg);
          }
        }

        .error-message {
          color: #dc3545;
          font-size: 0.875em;
          margin-top: 0.25rem;
          display: block;
        }

        .multiselect-pill {
            display: inline-flex;
            align-items: center;
            background-color: #003366;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            margin: 2px;
            line-height: 1.2;
        }
        .multiselect-pill-remove {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            margin-left: 0.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .multiselect-pill-remove:hover {
            opacity: 0.75;
        }

        /* Oculta o placeholder se houver pills */
        .multiselect-display:has(.multiselect-pill) .placeholder-text {
            display: none;
        }
        /* Mostra o placeholder se não houver pills */
         .multiselect-display:not(:has(.multiselect-pill)) .placeholder-text {
             display: inline-block;
        }
        .multiselect-display {
            min-height: 50px; /* Altura consistente com outros inputs */
        }
        .multiselect-dropdown {
            max-height: 240px;
            overflow-y: auto;
        }
        
        /* Wrapper customizado para select com seta */
        .custom-select-wrapper {
            position: relative;
        }
        .custom-select-wrapper .form-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 3rem; /* Espaço para a seta */
            border-radius: 0.375rem 0 0 0.375rem; /* rounded-l-md */
            border-right: none;
        }
        .custom-select-wrapper .custom-arrow {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 3rem; /* md:w-12 */
            background-color: #003366;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            border-radius: 0 0.375rem 0.375rem 0; /* rounded-r-md */
            font-size: 1.25rem; /* text-lg */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        
        <div class="bg-white p-6 md:p-10 rounded-lg shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-[#003366] mb-6">Formulário de Inscrição</h1>

            <!-- Container para feedback do formulário -->
            <div id="form-feedback" class="mb-4"></div>

            <!-- Início do Formulário -->
            <form id="form-comunidade" action="#" method="POST" novalidate>
                
                <!-- CSRF Token (Mock) -->
                <input type="hidden" name="csrfmiddlewaretoken" value="dummy-token-para-teste-frontend">

                <!-- Seção: Dados Pessoais -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 border-b border-gray-300 pb-2 mb-4">Dados Pessoais</h2>
                    
                    <div class="flex flex-wrap -mx-3">
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="nome_completo" class="sr-only">Nome Completo</label>
                            <input type="text" id="nome_completo" name="nome_completo" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" required>
                        </div>
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="data_nascimento" class="sr-only">Data de Nascimento</label>
                            <input type="date" id="data_nascimento" name="data_nascimento" class="form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" required>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap -mx-3">
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="email" class="sr-only">E-mail</label>
                            <input type="email" id="email" name="email" class="email form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="E-mail" required>
                        </div>
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="cpf" class="sr-only">CPF</label>
                            <input type="text" id="cpf" name="cpf" class="cpf form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="CPF" required maxlength="14">
                        </div>
                    </div>

                    <div class="flex flex-wrap -mx-3">
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="telefone" class="sr-only">Telefone Celular</label>
                            <input type="text" id="telefone" name="telefone" class="telefone form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" required maxlength="15">
                        </div>
                         <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="cep" class="sr-only">CEP</label>
                            <input type="text" id="cep" name="cep" class="cep form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="CEP" required maxlength="9">
                        </div>
                    </div>

                    <!-- Checkbox Menor de Idade -->
                    <div class="mb-4">
                        <label class="flex items-center text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="checkMenorIdade" name="checkMenorIdade" class="w-5 h-5 text-[#003366] bg-gray-100 border-gray-300 rounded focus:ring-[#003366] focus:ring-2">
                            <span class="ml-2">Sou menor de 18 anos</span>
                        </label>
                    </div>

                </section>

                <!-- Seção: Dados do Responsável (Oculta por padrão) -->
                <section id="dadosResponsavel" class="hidden mb-8 p-4 md:p-6 bg-gray-50 border border-gray-200 rounded-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados do Responsável Legal</h3>
                    
                    <div class="flex flex-wrap -mx-3">
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="nome_responsavel" class="sr-only">Nome Completo do Responsável</label>
                            <input type="text" id="nome_responsavel" name="nome_responsavel" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome do Responsável">
                        </div>
                        <div class="w-full md:w-1/2 px-3 mb-4">
                            <label for="cpf_responsavel" class="sr-only">CPF do Responsável</label>
                            <input type="text" id="cpf_responsavel" name="cpf_responsavel" class="cpf form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="CPF do Responsável" maxlength="14">
                        </div>
                    </div>
                </section>

                <!-- Seção: Saúde (com selects que serão substituídos) -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 border-b border-gray-300 pb-2 mb-4">Saúde e Bem-estar</h2>

                    <!-- Wrapper para o select que será substituído -->
                    <div class="custom-select-wrapper mb-4">
                        <label for="motivos_acompanhamento" class="sr-only">Motivos para acompanhamento</label>
                        <select id="motivos_acompanhamento" class="form-select block w-full bg-gray-100 border-none py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" multiple required>
                            <option value="" disabled>Motivos para acompanhamento (selecione um ou mais)</option>
                            <!-- Opções serão preenchidas pelo JS -->
                        </select>
                         <div class="custom-arrow">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>
                    </div>
                    
                    <div class="custom-select-wrapper mb-4">
                        <label for="medicamentos_usados" class="sr-only">Medicamentos em uso</label>
                        <select id="medicamentos_usados" class="form-select block w-full bg-gray-100 border-none py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" multiple required>
                            <option value="" disabled>Medicamentos em uso (selecione um ou mais)</option>
                        </select>
                         <div class="custom-arrow">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>
                    </div>

                    <div class="custom-select-wrapper mb-4">
                        <label for="pcd_neurodivergente" class="sr-only">PCD ou Neurodivergente</label>
                        <select id="pcd_neurodivergente" class="form-select block w-full bg-gray-100 border-none py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" multiple required>
                            <option value="" disabled>PCD ou Neurodivergente (selecione um ou mais)</option>
                        </select>
                         <div class="custom-arrow">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>
                    </div>

                    <div class="custom-select-wrapper mb-4">
                        <label for="doencas_fisicas" class="sr-only">Doenças físicas</label>
                        <select id="doencas_fisicas" class="form-select block w-full bg-gray-100 border-none py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" multiple required>
                            <option value="" disabled>Doenças físicas (selecione um ou mais)</option>
                        </select>
                         <div class="custom-arrow">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>
                    </div>

                    <!-- Exemplo de select simples (não-múltiplo) -->
                    <div class="custom-select-wrapper mb-4">
                        <label for="genero" class="sr-only">Gênero</label>
                        <select id="genero" name="genero" class="form-select block w-full bg-gray-100 border-none py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" required>
                            <option value="" disabled selected>Gênero</option>
                            <option value="feminino">Feminino</option>
                            <option value="masculino">Masculino</option>
                            <option value="nao_binario">Não-binário</option>
                            <option value="outro">Outro</option>
                            <option value="nao_informar">Prefiro não informar</option>
                        </select>
                         <div class="custom-arrow">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>
                    </div>

                </section>

                <!-- Seção: Contatos de Emergência -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 border-b border-gray-300 pb-2 mb-4">Contatos de Emergência</h2>
                    
                    <div id="emergencyContactsContainer">
                        <!-- Primeiro contato (padrão) -->
                        <div class="contact-entry relative p-4 md:p-6 bg-gray-50 border border-gray-200 rounded-md">
                            <div class="flex flex-wrap -mx-3">
                                <h5 class="w-full px-3 font-bold text-base mt-0 mb-2 text-[#003366]">Contato 1</h5>
                                <div class="w-full md:w-1/2 px-3">
                                    <div class="mb-4 md:mb-0">
                                        <label for="nome_urgencia_1" class="sr-only">Nome Completo Contato 1</label>
                                        <input type="text" id="nome_urgencia_1" name="nome_urgencia[]" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" required>
                                    </div>
                                </div>
                                <div class="w-full md:w-1/2 px-3">
                                    <div class="mb-0">
                                        <label for="telefone_urgencia_1" class="sr-only">Telefone Celular Contato 1</label>
                                        <input type="text" id="telefone_urgencia_1" name="telefone_urgencia[]" class="telefone form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" required maxlength="15">
                                    </div>
                                </div>
                            </div>
                            <!-- Botão de remover (escondido para o primeiro) -->
                            <button type="button" class="remove-contact-btn hidden absolute top-2.5 right-2.5 bg-red-600 text-white border-none rounded-full w-8 h-8 text-lg items-center justify-center leading-none shadow-md transition-all duration-200 ease-in-out hover:bg-red-700 hover:scale-110" aria-label="Remover Contato 1"><i class="bi bi-dash" aria-hidden="true"></i></button>
                        </div>
                    </div>

                    <!-- Botão Adicionar Contato -->
                    <div class="mt-4 text-right">
                        <button type="button" id="addContactBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow hover:bg-green-700 transition-colors duration-200">
                            + Adicionar Contato
                        </button>
                    </div>
                </section>

                <!-- Seção: Termos e Submissão -->
                <section>
                    <!-- Checkbox LGPD -->
                    <div class="mb-6">
                        <label class="flex items-start text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="checkLGPD" name="checkLGPD" class="w-5 h-5 text-[#003366] bg-gray-100 border-gray-300 rounded focus:ring-[#003366] focus:ring-2 mt-1 flex-shrink-0" required>
                            <span class="ml-2">Eu li e concordo com os Termos de Uso e a Política de Privacidade, e autorizo o processamento dos meus dados pessoais conforme a LGPD.</span>
                        </label>
                    </div>

                    <!-- Botão de Envio -->
                    <div class="text-center">
                        <button type="submit" id="submit-button" class="w-full md:w-auto bg-[#003366] text-white font-bold text-base py-3 px-10 rounded-md shadow-lg hover:bg-opacity-90 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 disabled:opacity-70 disabled:cursor-not-allowed">
                            Salvar Inscrição
                        </button>
                    </div>
                </section>

            </form>
            <!-- Fim do Formulário -->

        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const form = document.getElementById('form-comunidade');
            if (!form) {
                console.error("Erro Crítico: O formulário com ID 'form-comunidade' não foi encontrado.");
                return;
            }

            // --- Referências ---
            const submitButton = document.getElementById('submit-button');
            const formFeedback = document.getElementById('form-feedback');
            // ------------------------

            const csrfTokenInput = form.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenInput || !csrfTokenInput.value) {
                console.warn('Input CSRF token não encontrado ou vazio. O envio para o Django falhará.');
            }
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

            const checkMenor = document.getElementById('checkMenorIdade');
            const dadosResponsavel = document.getElementById('dadosResponsavel');
            
            // Validação para garantir que os elementos existem
            if (!checkMenor || !dadosResponsavel) {
                console.error("Erro: Checkbox 'checkMenorIdade' ou container 'dadosResponsavel' não encontrados.");
                return;
            }
            const inputsResponsavel = dadosResponsavel.querySelectorAll('input, select');


            function toggleResponsavel() {
                const isChecked = checkMenor.checked;
                // Usa classes 'hidden' e 'block' do Tailwind
                if (isChecked) {
                    dadosResponsavel.classList.remove('hidden');
                    dadosResponsavel.classList.add('block');
                } else {
                    dadosResponsavel.classList.remove('block');
                    dadosResponsavel.classList.add('hidden');
                }

                inputsResponsavel.forEach(input => {
                    input.required = isChecked;
                    if (!isChecked) {
                        input.value = '';
                        if (input.tagName === 'SELECT') {
                            updateSelectColor(input);
                        }
                        input.classList.remove('input-error');
                        // Encontra o parente mais próximo que contém o campo
                        const parent = input.closest('.mb-4') || input.closest('.custom-select-wrapper');
                        const errorMsg = parent ? parent.querySelector('.error-message') : null;
                        if (errorMsg) errorMsg.remove();
                    }
                });
            }

            checkMenor.addEventListener('change', toggleResponsavel);
            toggleResponsavel(); // Executa ao carregar a página

            /**
             * Atualiza a cor do texto de um <select> com base se 
             * a opção "placeholder" (value="") está selecionada.
             */
            function updateSelectColor(select) {
                if (select.value === "") {
                    select.style.color = '#6c757d'; // Cor do placeholder
                } else {
                    select.style.color = '#333'; // Cor do texto
                }
            }

            // Aplica a lógica de cor aos selects normais (não-multiplos)
            document.querySelectorAll('.form-select:not([multiple])').forEach(select => {
                select.addEventListener('change', () => updateSelectColor(select));
                updateSelectColor(select);
            });

            const contactsContainer = document.getElementById('emergencyContactsContainer');
            const addContactBtn = document.getElementById('addContactBtn');
            
            if (!contactsContainer || !addContactBtn) {
                 console.error("Erro: 'emergencyContactsContainer' ou 'addContactBtn' não encontrados.");
                 return;
            }
            
            let contactCount = 1;

            addContactBtn.addEventListener('click', function () {
                contactCount++;
                const newContact = document.createElement('div');
                // Adiciona classes do Tailwind para o novo 'contact-entry'
                newContact.className = 'contact-entry relative p-4 md:p-6 bg-gray-50 border border-gray-200 rounded-md mt-4';
                newContact.innerHTML = `
                        <div class="flex flex-wrap -mx-3">
                            <h5 class="w-full px-3 font-bold text-base mt-0 mb-2 text-[#003366]">Contato ${contactCount}</h5>
                            <div class="w-full md:w-1/2 px-3">
                                <div class="mb-4 md:mb-0">
                                    <label for="nome_urgencia_${contactCount}" class="sr-only">Nome Completo Contato ${contactCount}</label>
                                    <input type="text" id="nome_urgencia_${contactCount}" name="nome_urgencia[]" class="apenas-letras form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Nome Completo" required>
                                </div>
                            </div>
                            <div class="w-full md:w-1/2 px-3">
                                <div class="mb-0">
                                    <label for="telefone_urgencia_${contactCount}" class="sr-only">Telefone Celular Contato ${contactCount}</label>
                                    <input type="text" id="telefone_urgencia_${contactCount}" name="telefone_urgencia[]" class="telefone form-control block w-full bg-gray-100 border-none rounded-md py-3 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base" placeholder="Telefone Celular" required maxlength="15">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="remove-contact-btn absolute top-2.5 right-2.5 bg-red-600 text-white border-none rounded-full w-8 h-8 text-lg flex items-center justify-center leading-none shadow-md transition-all duration-200 ease-in-out hover:bg-red-700 hover:scale-110" aria-label="Remover Contato ${contactCount}"><i class="bi bi-dash" aria-hidden="true"></i></button>
                    `;
                contactsContainer.appendChild(newContact);

                // Adiciona formatação de máscara aos novos campos
                newContact.querySelectorAll('.telefone').forEach(input => {
                    input.addEventListener('input', (e) => e.target.value = formatTelefone(e.target.value));
                });
                newContact.querySelectorAll('.apenas-letras').forEach(input => {
                    input.addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^\p{L}\s'-]/gu, ''));
                });
            });

            contactsContainer.addEventListener('click', function (e) {
                const removeBtn = e.target.closest('.remove-contact-btn');
                if (removeBtn) {
                    // Não remove o primeiro contato
                    const contactEntry = removeBtn.closest('.contact-entry');
                    if (contactEntry.parentElement.querySelectorAll('.contact-entry').length > 1) {
                         contactEntry.remove();
                         updateContactNumbers();
                    }
                }
            });

            function updateContactNumbers() {
                const allContacts = contactsContainer.querySelectorAll('.contact-entry');
                allContacts.forEach((contact, index) => {
                    const title = contact.querySelector('h5');
                    if (title) title.textContent = `Contato ${index + 1}`;

                    const removeBtn = contact.querySelector('.remove-contact-btn');
                    if (removeBtn) {
                        removeBtn.setAttribute('aria-label', `Remover Contato ${index + 1}`);
                        // Mostra o botão de remover para todos, exceto o primeiro
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                        }
                    }

                    const nomeInput = contact.querySelector('input[name="nome_urgencia[]"]');
                    const nomeLabel = contact.querySelector(`label[for^="nome_urgencia_"]`);
                    if (nomeInput) nomeInput.id = `nome_urgencia_${index + 1}`;
                    if (nomeLabel) nomeLabel.setAttribute('for', `nome_urgencia_${index + 1}`);

                    const telInput = contact.querySelector('input[name="telefone_urgencia[]"]');
                    const telLabel = contact.querySelector(`label[for^="telefone_urgencia_"]`);
                    if (telInput) telInput.id = `telefone_urgencia_${index + 1}`;
                    if (telLabel) telLabel.setAttribute('for', `telefone_urgencia_${index + 1}`);
                });
                contactCount = allContacts.length;
            }
            
            // Garante que o botão de remover do primeiro contato esteja oculto no load
            updateContactNumbers();

            /**
             * Exibe uma mensagem de feedback no topo do formulário.
             * @param {'success' | 'danger'} type - O tipo de alerta.
             * @param {string} message - A mensagem HTML para exibir.
             */
            function showMessage(type, message) {
                const alertDiv = document.createElement('div');
                // Usa as novas classes CSS personalizadas
                alertDiv.className = `form-feedback-box feedback-${type}`;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                        ${message}
                        <button type="button" class="feedback-close-btn" aria-label="Close"></button>
                    `;

                formFeedback.innerHTML = ''; // Limpa mensagens antigas
                formFeedback.appendChild(alertDiv);

                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // --- NOVO: Listener para fechar os alertas customizados ---
            formFeedback.addEventListener('click', function (e) {
                const closeButton = e.target.closest('.feedback-close-btn');
                if (closeButton) {
                    const alertBox = closeButton.closest('.form-feedback-box');
                    // Adiciona um efeito de fade out simples
                    alertBox.style.opacity = '0';
                    setTimeout(() => alertBox.remove(), 150);
                }
            });


            // --- INÍCIO LÓGICA MULTI-SELECT ---

            // Define as opções para os campos multi-select
            // (As opções foram removidas do HTML para serem gerenciadas aqui)
            const multiSelectOptions = {
                'motivos_acompanhamento': [
                    { value: "ansiedade", text: "Ansiedade" },
                    { value: "assediomoral", text: "Assédio Moral" },
                    { value: "depressao", text: "Depressão" },
                    { value: "dfaprendizagem", text: "Dificuldade de Aprendizagem" },
                    { value: "humorinstavel", text: "Humor Instável" },
                    { value: "insonia", text: "Insônia" },
                    { value: "isolasocial", text: "Isolamento Social" },
                    { value: "luto", text: "Luto" },
                    { value: "tristeza", text: "Tristeza" },
                    { value: "apatia", text: "Apatia" },
                    { value: "exaustao", text: "Exaustão" },
                    { value: "fadiga", text: "Fadiga" },
                    { value: "faltanimo", text: "Falta Ânimo" },
                    { value: "assediosexual", text: "Assédio Sexual" },
                    { value: "outro", text: "Outro" }
                ],
                'medicamentos_usados': [
                    { value: "ansiolitico", text: "Ansiolítico" },
                    { value: "antidepressivo", text: "Antidepressivo" },
                    { value: "antipsicotico", text: "Antipsicótico" },
                    { value: "estabhumor", text: "Estabilizador de Humor" },
                    { value: "memoriatct", text: "Medicamentos para memória, atenção e concentração" },
                    { value: "nenhum", text: "Nenhum" },
                    { value: "outro", text: "Outro" }
                ],
                'pcd_neurodivergente': [
                    { value: "tea", text: "TEA (Transtorno do Espectro Autista)" },
                    { value: "tdah", text: "TDAH (Transtorno do Déficit de Atenção com Hiperatividade)" },
                    { value: "def_fisica", text: "Deficiência Física" },
                    { value: "def_visual", text: "Deficiência Visual" },
                    { value: "def_auditiva", text: "Deficiência Auditiva" },
                    { value: "transtorno_aprendizagem", text: "Transtornos de Aprendizagem (Dislexia, etc.)" },
                    { value: "altas_habilidades", text: "Altas Habilidades / Superdotação" },
                    { value: "nenhum", text: "Nenhum" },
                    { value: "outro", text: "Outro" }
                ],
                'doencas_fisicas': [
                    { value: "doencaresp", text: "Doenças respiratórias" },
                    { value: "cancer", text: "Câncer" },
                    { value: "diabete", text: "Diabetes" },
                    { value: "disfusexul", text: "Disfunções sexuais" },
                    { value: "doencadgt", text: "Doenças degenerativas" },
                    { value: "escleorosemlt", text: "Esclerose múltipla" },
                    { value: "hcpt", text: "Hipertensão ou cardiopatias" },
                    { value: "luposatm", text: "Lúpus ou outras doenças autoimunes" },
                    { value: "obesidade", text: "Obesidade" },
                    { value: "pblmarenal", text: "Problemas renais" },
                    { value: "nenhum", text: "Nenhum" },
                    { value: "outro", text: "Outro" }
                ]
            };

            // Estado para rastrear seleções (ex: { motivos_acompanhamento: ['ansiedade', 'luto'] })
            const multiSelectState = {};

            /**
             * Inicializa todos os componentes multi-select no formulário.
             */
            function initializeMultiSelects() {
                Object.keys(multiSelectOptions).forEach(fieldId => {
                    const originalSelect = document.getElementById(fieldId);
                    if (!originalSelect) {
                        console.warn(`Campo select original com ID '${fieldId}' não encontrado para multi-select.`);
                        return;
                    }

                    const placeholder = originalSelect.querySelector('option[disabled]')?.textContent || 'Selecione uma ou mais opções';
                    const options = multiSelectOptions[fieldId];
                    
                    // Inicializa o estado
                    multiSelectState[fieldId] = [];

                    // Cria o novo componente HTML
                    const multiSelectWrapper = document.createElement('div');
                    multiSelectWrapper.className = 'custom-multiselect-wrapper relative mb-4';
                    multiSelectWrapper.dataset.fieldId = fieldId;

                    multiSelectWrapper.innerHTML = `
                        <label for="${fieldId}_display" class="sr-only">${placeholder}</label>
                        
                        <!-- MODIFICADO: Removido rounded-md, adicionado rounded-l-md e pr-12 -->
                        <div id="${fieldId}_display" name="${fieldId}_display" class="multiselect-display form-control flex items-center flex-wrap gap-1 block w-full bg-gray-100 border-none rounded-l-md py-2 px-4 text-sm text-gray-800 focus:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-[#003366] focus:ring-opacity-60 md:text-base cursor-pointer pr-12" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false">
                            <span class="placeholder-text text-gray-500">${placeholder}</span>
                        </div>

                        <!-- ADICIONADO: Seta azul igual aos outros selects -->
                        <div class="custom-arrow absolute top-0 right-0 bottom-0 w-10 bg-[#003366] text-white flex items-center justify-center pointer-events-none rounded-r-md text-lg md:w-12">
                            <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                        </div>

                        <div class="multiselect-dropdown absolute hidden top-full left-0 right-0 z-10 bg-white border border-gray-300 rounded-md shadow-lg mt-1" role="listbox">
                            ${options.map(option => `
                                <div class="multiselect-option flex items-center p-2 hover:bg-gray-100 cursor-pointer" data-value="${option.value}" role="option" aria-selected="false">
                                    <input type="checkbox" class="w-4 h-4 text-[#003366] rounded border-gray-300 focus:ring-[#003366] mr-2 pointer-events-none" tabindex="-1">
                                    <span>${option.text}</span>
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" id="${fieldId}" name="${fieldId}" class="multiselect-hidden-input">
                    `;

                    // Substitui o select original pelo novo componente
                    originalSelect.closest('.custom-select-wrapper').replaceWith(multiSelectWrapper);

                    // --- Adiciona Event Listeners para o novo componente ---
                    const display = multiSelectWrapper.querySelector('.multiselect-display');
                    const dropdown = multiSelectWrapper.querySelector('.multiselect-dropdown');
                    const optionsElements = multiSelectWrapper.querySelectorAll('.multiselect-option');

                    // Abrir/Fechar dropdown
                    display.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isExpanded = dropdown.classList.contains('hidden');
                        closeAllMultiSelects(); // Fecha todos os outros
                        if (isExpanded) {
                            dropdown.classList.remove('hidden');
                            display.setAttribute('aria-expanded', 'true');
                        } else {
                            dropdown.classList.add('hidden');
                            display.setAttribute('aria-expanded', 'false');
                        }
                    });

                    // Selecionar/Deselecionar opção
                    optionsElements.forEach(optionEl => {
                        optionEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const value = optionEl.dataset.value;
                            toggleMultiSelectOption(fieldId, value);
                        });
                    });
                });
            }

            /**
             * Fecha todos os dropdowns multi-select abertos.
             */
            function closeAllMultiSelects() {
                document.querySelectorAll('.multiselect-dropdown').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                    const display = dropdown.previousElementSibling.previousElementSibling; // Pula a seta
                    if (display && display.classList.contains('multiselect-display')) {
                        display.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            /**
             * Alterna o estado de uma opção multi-select.
             * @param {string} fieldId - O ID do campo (ex: 'motivos_acompanhamento').
             * @param {string} value - O valor da opção clicada.
             */
            function toggleMultiSelectOption(fieldId, value) {
                const state = multiSelectState[fieldId];
                if (!state) return;
                
                const index = state.indexOf(value);

                // Lógica "Nenhum"
                if (value === 'nenhum') {
                    if (index > -1) {
                         state.splice(index, 1); // Desmarca "Nenhum"
                    } else {
                        state.length = 0; // Limpa o array
                        state.push('nenhum'); // Adiciona apenas "Nenhum"
                    }
                } else {
                    // Se "Nenhum" estiver marcado, desmarque-o
                    const nenhumIndex = state.indexOf('nenhum');
                    if (nenhumIndex > -1) {
                        state.splice(nenhumIndex, 1);
                    }
                    
                    // Adiciona ou remove o item clicado
                    if (index > -1) {
                        state.splice(index, 1); // Remove
                    } else {
                        state.push(value); // Adiciona
                    }
                }

                updateMultiSelectUI(fieldId);
            }

            /**
             * Atualiza a UI (pills e input oculto) de um campo multi-select.
             * @param {string} fieldId - O ID do campo a ser atualizado.
             */
            function updateMultiSelectUI(fieldId) {
                const wrapper = document.querySelector(`.custom-multiselect-wrapper[data-field-id="${fieldId}"]`);
                if (!wrapper) return;

                const display = wrapper.querySelector('.multiselect-display');
                const hiddenInput = wrapper.querySelector('.multiselect-hidden-input');
                const placeholder = display.querySelector('.placeholder-text');
                const options = multiSelectOptions[fieldId];
                const state = multiSelectState[fieldId];

                // 1. Limpa pills antigos
                display.querySelectorAll('.multiselect-pill').forEach(pill => pill.remove());

                // 2. Adiciona pills novos
                state.forEach(value => {
                    const option = options.find(o => o.value === value);
                    if (!option) return;

                    const pill = document.createElement('span');
                    pill.className = 'multiselect-pill';
                    pill.dataset.value = value;
                    pill.innerHTML = `
                        <span>${option.text}</span>
                        <button type="button" class="multiselect-pill-remove" aria-label="Remover ${option.text}">&times;</button>
                    `;
                    
                    // Adiciona o pill antes do placeholder
                    display.insertBefore(pill, placeholder);
                });

                // 3. Atualiza o input oculto
                hiddenInput.value = state.join(','); // Envia como string separada por vírgula

                // 4. Atualiza o estado dos checkboxes no dropdown
                wrapper.querySelectorAll('.multiselect-option').forEach(optionEl => {
                    const value = optionEl.dataset.value;
                    const checkbox = optionEl.querySelector('input[type="checkbox"]');
                    if (state.includes(value)) {
                        checkbox.checked = true;
                        optionEl.setAttribute('aria-selected', 'true');
                    } else {
                        checkbox.checked = false;
                        optionEl.setAttribute('aria-selected', 'false');
                    }
                });

                 // 5. Limpa erro se o usuário selecionar algo
                 if (state.length > 0) {
                     clearMultiSelectError(fieldId);
                 }
            }
            
            /** Limpa o erro de um campo multi-select específico */
            function clearMultiSelectError(fieldId) {
                 const wrapper = document.querySelector(`.custom-multiselect-wrapper[data-field-id="${fieldId}"]`);
                 if (!wrapper) return;
                 const display = wrapper.querySelector('.multiselect-display');
                 
                 if (display.classList.contains('input-error')) {
                     display.classList.remove('input-error');
                     const errorMsg = wrapper.querySelector('.error-message');
                     if (errorMsg) errorMsg.remove();
                 }
            }

            // --- Event Listeners Globais do Multi-Select ---

            // Clica para remover um pill
            form.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.multiselect-pill-remove');
                if (removeBtn) {
                    e.preventDefault(); // Impede o clique de fechar o dropdown
                    e.stopPropagation(); // Impede o clique de fechar o dropdown
                    const pill = removeBtn.closest('.multiselect-pill');
                    const wrapper = removeBtn.closest('.custom-multiselect-wrapper');
                    const fieldId = wrapper.dataset.fieldId;
                    const value = pill.dataset.value;
                    
                    toggleMultiSelectOption(fieldId, value);
                }
            });

            // Clica fora para fechar
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-multiselect-wrapper')) {
                    closeAllMultiSelects();
                }
            });

            // Inicializa os componentes
            initializeMultiSelects();

            // --- FIM LÓGICA MULTI-SELECT ---


            /** Limpa todos os erros de validação da tela. */
            function clearErrors() {
                form.querySelectorAll('.error-message').forEach(el => el.remove());
                form.querySelectorAll('.input-error').forEach(el => {
                    el.classList.remove('input-error');
                });
                formFeedback.innerHTML = '';
            }

            /**
             * Exibe erros de validação do backend nos campos correspondentes.
             * @param {Object} erros - Um objeto onde a chave é o 'id' do campo e o valor é um array de mensagens.
             */
            function displayErrors(erros) {
                console.log("Erros de validação:", erros);

                let firstErrorField = null;

                for (const [fieldName, errorMessages] of Object.entries(erros)) {
                    let campo = document.getElementById(fieldName);

                    // --- AJUSTE MULTI-SELECT ---
                    // Se o ID for de um display (ex: "motivos_acompanhamento_display")
                    if (!campo && fieldName.endsWith('_display')) {
                        campo = document.getElementById(fieldName);
                    }
                    // --- FIM AJUSTE ---

                    if (!campo && fieldName.includes('[]')) {
                        // Tenta encontrar campos de array (ex: nome_urgencia[])
                        const camposArray = form.querySelectorAll(`[name="${fieldName}"]`);
                        if (camposArray.length > 0) campo = camposArray[0]; // Pega o primeiro, por exemplo
                    } else if (!campo) {
                        // Tenta encontrar por 'name' se 'id' falhar
                        campo = form.querySelector(`[name="${fieldName}"]`);
                    }

                    if (campo) {
                        if (!firstErrorField) firstErrorField = campo;

                        // --- AJUSTE MULTI-SELECT ---
                        // O 'campo' é o display, mas o 'parentWrapper' é o wrapper principal
                        let parentWrapper;
                        if (campo.classList.contains('multiselect-display')) {
                            campo.classList.add('input-error');
                            parentWrapper = campo.closest('.custom-multiselect-wrapper');
                        } else {
                             // --- AJUSTE CHECKBOX ---
                            if (campo.type === 'checkbox') {
                                // Para checkboxes, o erro vai depois do wrapper
                                parentWrapper = campo.closest('.mb-4') || campo.closest('.mb-6') || campo.parentNode;
                            } else {
                                campo.classList.add('input-error');
                                parentWrapper = campo.closest('.custom-select-wrapper') || campo.closest('.mb-4') || campo.parentNode;
                            }
                        }
                        // --- FIM AJUSTE ---

                        // Evita duplicar mensagens
                        if (parentWrapper && !parentWrapper.querySelector('.error-message')) {
                            const erroEl = document.createElement('span');
                            erroEl.className = 'error-message'; // Classe definida em comunidade.css
                            erroEl.textContent = Array.isArray(errorMessages) ? errorMessages.join(' ') : errorMessages;
                            
                            // Insere após o último elemento no wrapper
                            parentWrapper.appendChild(erroEl);
                        }

                    } else {
                        console.warn(`Campo de erro '${fieldName}' não encontrado no DOM.`);
                    }
                }

                // Se a mensagem de erro não for a geral, exibe a geral.
                if (!formFeedback.querySelector('.feedback-danger')) {
                    showMessage('danger', '<strong>Erro de validação:</strong> Por favor, verifique os campos destacados.');
                }

                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }


            // --- NOVO: Funções de Validação Client-Side ---

            /** Valida um email usando Regex. */
            function isValidEmail(email) {
                const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(String(email).toLowerCase());
            }

            /** Valida o comprimento de um CPF (apenas dígitos). */
            function isValidCPF(cpf) {
                const digits = cpf.replace(/\D/g, '');
                return digits.length === 11;
            }

            /** Valida o comprimento de um Telefone (10 ou 11 dígitos). */
            function isValidTelefone(tel) {
                const digits = tel.replace(/\D/g, '');
                return digits.length >= 10 && digits.length <= 11;
            }

            /** Valida o comprimento de um CEP (8 dígitos). */
            function isValidCEP(cep) {
                const digits = cep.replace(/\D/g, '');
                return digits.length === 8;
            }


            /**
             * --- NOVO: Função principal de validação client-side ---
             * @returns {boolean} - Retorna true se o formulário for válido, false caso contrário.
             */
            function validateForm() {
                const errors = {};
                
                // 1. Pega todos os campos 'required' que estão visíveis (ignora os da seção 'responsavel' se ocultos)
                const requiredFields = form.querySelectorAll('[required]');
                
                requiredFields.forEach(field => {
                    // Ignora campos dentro da seção de responsável oculta
                    if (field.closest('#dadosResponsavel') && dadosResponsavel.classList.contains('hidden')) {
                        return;
                    }
                    
                    // Ignora os selects originais que foram substituídos (eles ainda estão no DOM, mas dentro do 'hidden')
                    if (multiSelectOptions.hasOwnProperty(field.id) && field.tagName === 'SELECT') {
                        return;
                    }
                     
                    // Ignora checkbox LGPD, checado separadamente
                    if (field.id === 'checkLGPD') {
                        return;
                    }
                     
                    const fieldId = field.id;
                    const fieldValue = field.value.trim();

                    // Checa campos vazios
                    if (field.tagName === 'SELECT' && fieldValue === '') {
                        errors[fieldId] = 'Este campo é obrigatório.';
                    } else if (field.type === 'date' && fieldValue === '') {
                         errors[fieldId] = 'Este campo é obrigatório.';
                    } else if (field.tagName !== 'SELECT' && field.type !== 'date' && fieldValue === '') {
                        errors[fieldId] = 'Este campo é obrigatório.';
                    }

                    // Checa formatos específicos (se não estiverem vazios)
                    else if (fieldValue !== '' && field.classList.contains('email') && !isValidEmail(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um e-mail válido.';
                    }
                    else if (fieldValue !== '' && field.classList.contains('cpf') && !isValidCPF(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um CPF válido (11 dígitos).';
                    }
                    else if (fieldValue !== '' && field.classList.contains('telefone') && !isValidTelefone(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um telefone válido (10 ou 11 dígitos).';
                    }
                    else if (fieldValue !== '' && field.classList.contains('cep') && !isValidCEP(fieldValue)) {
                        errors[fieldId] = 'Por favor, insira um CEP válido (8 dígitos).';
                    }
                });

                // --- NOVA VALIDAÇÃO MULTI-SELECT ---
                Object.keys(multiSelectOptions).forEach(fieldId => {
                    const wrapper = document.querySelector(`.custom-multiselect-wrapper[data-field-id="${fieldId}"]`);
                    if (!wrapper) return;
                    
                    const hiddenInput = document.getElementById(fieldId);
                    const display = wrapper.querySelector('.multiselect-display');
                    
                    // Assumindo que todos os campos convertidos são 'required'
                    if (hiddenInput.value.trim() === '') {
                        errors[display.id] = 'Este campo é obrigatório.'; // Usa o ID do display para o displayErrors
                    }
                });
                // --- FIM VALIDAÇÃO MULTI-SELECT ---

                // 2. Checa o Checkbox LGPD
                const checkLGPD = document.getElementById('checkLGPD');
                if (!checkLGPD.checked) {
                    errors[checkLGPD.id] = 'Você deve concordar com os termos.';
                }

                // 3. Processa os erros
                if (Object.keys(errors).length > 0) {
                    displayErrors(errors);
                    return false;
                }

                return true;
            }


            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                clearErrors();

                // --- MELHORIA: Validação client-side antes do envio ---
                const isFormValid = validateForm();
                if (!isFormValid) {
                    return; // Para a execução se o formulário for inválido
                }
                // --- Fim da validação ---

                // --- Estado de Loading (usa nova classe de spinner) ---
                submitButton.disabled = true;
                submitButton.innerHTML = `
                        <span class="loading-spinner" role="status" aria-hidden="true"></span>
                        Enviando...
                    `;

                const formData = new FormData(form);
                const dadosObjeto = {};

                const keys = new Set();
                for (const key of formData.keys()) {
                    keys.add(key);
                }

                for (const key of keys) {
                    if (key === 'csrfmiddlewaretoken') continue;

                    // Ignora os campos multi-select aqui, eles serão tratados abaixo
                    if (multiSelectOptions.hasOwnProperty(key)) continue;

                    if (key.endsWith('[]')) {
                        const cleanKey = key.slice(0, -2);
                        dadosObjeto[cleanKey] = formData.getAll(key);
                    } else {
                        dadosObjeto[key] = formData.get(key);
                    }
                }

                // --- INSERÇÃO MULTI-SELECT ---
                // Pega os valores dos inputs ocultos e transforma em arrays
                Object.keys(multiSelectOptions).forEach(fieldId => {
                    const hiddenInput = document.getElementById(fieldId);
                    if (hiddenInput) {
                        // Envia como um array de strings
                        dadosObjeto[fieldId] = hiddenInput.value.split(',').filter(Boolean); // filter(Boolean) remove strings vazias
                    }
                });
                // --- FIM INSERÇÃO MULTI-SELECT ---

                dadosObjeto.menorIdade = checkMenor.checked;
                dadosObjeto.deAcordo = document.getElementById('checkLGPD').checked;

                console.log("Dados a serem enviados (JSON):", dadosObjeto);

                /*
                // Simulação de envio para teste, já que não temos o endpoint
                // Substitua este bloco try/catch pelo seu original quando for para produção
                
                try {
                     // Simulação de espera de 1.5s
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // Simulação de Sucesso (descomente para testar)
                    const response = { ok: true };
                    const resultado = { mensagem: 'Inscrição simulada com sucesso!' };

                    // Simulação de Erro de Validação (descomente para testar)
                    // const response = { ok: false };
                    // const resultado = { 
                    //     status: 'erro_validacao', 
                    //     erros: { 
                    //         'email': 'Este e-mail já está cadastrado.', 
                    //         'cpf': 'CPF inválido.',
                    //         'motivos_acompanhamento_display': 'Seleção inválida.' , // Erro no multi-select
                    //         'checkLGPD': 'Você deve aceitar os termos.' // Erro no checkbox
                    //     }
                    // };
                    
                    // Simulação de Erro de Servidor (descomente para testar)
                    // const response = { ok: false };
                    // const resultado = { mensagem: 'Erro interno no servidor (Simulado).' };

                    if (response.ok) {
                        showMessage('success', `<strong>Sucesso!</strong> ${resultado.mensagem || 'Inscrição realizada com sucesso!'}`);

                        form.reset();
                        
                        // --- RESET MULTI-SELECT UI ---
                        Object.keys(multiSelectState).forEach(fieldId => {
                            multiSelectState[fieldId] = []; // Limpa o estado
                            updateMultiSelectUI(fieldId); // Atualiza a UI (remove pills, mostra placeholder)
                        });
                        // --- FIM RESET ---

                        document.querySelectorAll('.form-select').forEach(updateSelectColor);
                        // Reseta a cor dos inputs de data
                        document.querySelectorAll('input[type="date"]').forEach(input => input.style.color = '#6c757d');
                        
                        toggleResponsavel();

                        const extraContacts = contactsContainer.querySelectorAll('.contact-entry:not(:first-child)');
                        extraContacts.forEach(contact => contact.remove());
                        updateContactNumbers();

                    } else if (resultado.status === 'erro_validacao') {
                        displayErrors(resultado.erros);
                    } else {
                        showMessage('danger', `Erro do servidor: ${resultado.mensagem || 'Erro desconhecido.'}`);
                    }

                } catch (error) {
                    console.error('Erro de comunicação:', error);
                    showMessage('danger', 'Ocorreu um erro de comunicação com o servidor. Tente novamente mais tarde.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Salvar Inscrição';
                }
                */
                
                
                // SEU CÓDIGO DE FETCH ORIGINAL:
                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(dadosObjeto)
                    });

                    const resultado = await response.json();

                    if (response.ok) {
                        showMessage('success', `<strong>Sucesso!</strong> ${resultado.mensagem || 'Inscrição realizada com sucesso!'}`);

                        form.reset();
                        
                        // --- RESET MULTI-SELECT UI ---
                        Object.keys(multiSelectState).forEach(fieldId => {
                            multiSelectState[fieldId] = []; // Limpa o estado
                            updateMultiSelectUI(fieldId); // Atualiza a UI (remove pills, mostra placeholder)
                        });
                        // --- FIM RESET ---
                        
                        document.querySelectorAll('.form-select').forEach(updateSelectColor);
                        // Reseta a cor dos inputs de data
                        document.querySelectorAll('input[type="date"]').forEach(input => input.style.color = '#6c757d');
                        
                        toggleResponsavel();

                        const extraContacts = contactsContainer.querySelectorAll('.contact-entry:not(:first-child)');
                        extraContacts.forEach(contact => contact.remove());
                        updateContactNumbers();

                    } else if (resultado.status === 'erro_validacao') {
                        displayErrors(resultado.erros);
                    } else {
                        showMessage('danger', `Erro do servidor: ${resultado.mensagem || 'Erro desconhecido.'}`);
                    }

                } catch (error) {
                    console.error('Erro de comunicação:', error);
                    showMessage('danger', 'Ocorreu um erro de comunicação com o servidor. Tente novamente mais tarde.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Salvar Inscrição';
                }
            });

            // --- Funções de Formatação (Máscaras) ---

            function formatCPF(value) {
                const digits = value.replace(/\D/g, '').slice(0, 11);
                if (digits.length <= 3) return digits;
                if (digits.length <= 6) return digits.replace(/(\d{3})(\d)/, '$1.$2');
                if (digits.length <= 9) return digits.replace(/(\d{3})(\d{3})(\d)/, '$1.$2.$3');
                return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
            }

            function formatTelefone(value) {
                const digits = value.replace(/\D/g, '').slice(0, 11);
                if (digits.length <= 2) return `(${digits}`; 
                if (digits.length <= 7) return digits.replace(/(\d{2})(\d)/, '($1) $2'); 
                if (digits.length <= 10) return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3'); // Fixo
                return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3'); // Celular
            }

            function formatCEP(value) {
                const digits = value.replace(/\D/g, '').slice(0, 8);
                if (digits.length <= 5) return digits;
                return digits.replace(/(\d{5})(\d{1,3})/, '$1-$2');
            }

            form.addEventListener('input', function (e) {
                const target = e.target;

                // Limpa erro ao digitar
                if (target.classList.contains('input-error')) {
                    target.classList.remove('input-error');
                    const parent = target.closest('.custom-select-wrapper') || target.closest('.mb-4') || target.parentNode;
                    const errorMsg = parent ? parent.querySelector('.error-message') : null;
                    if (errorMsg) errorMsg.remove();
                }

                // Aplica máscaras
                if (target.classList.contains('cpf')) {
                    target.value = formatCPF(target.value);
                }

                if (target.classList.contains('telefone')) {
                    target.value = formatTelefone(target.value);
                }

                if (target.classList.contains('cep')) {
                    target.value = formatCEP(target.value);
                }

                if (target.classList.contains('apenas-letras')) {
                    // --- MELHORIA: Permite letras, espaços, apóstrofos e hífens ---
                    target.value = target.value.replace(/[^\p{L}\s'-]/gu, '');
                }
            });

            // Limpa erro ao mudar select ou checkbox
            form.addEventListener('change', function (e) {
                const target = e.target;
                
                // Inputs de Data
                if (target.type === 'date') {
                     target.style.color = '#333'; // Muda a cor ao selecionar
                }

                let parentWrapper = null;
                
                if (target.tagName === 'SELECT') {
                    parentWrapper = target.closest('.custom-select-wrapper');
                } else if (target.type === 'checkbox') {
                    parentWrapper = target.closest('.mb-4') || target.closest('.mb-6');
                }
                
                if (parentWrapper) {
                     const errorMsg = parentWrapper.querySelector('.error-message');
                     if (errorMsg) errorMsg.remove();
                }
                 
                if (target.classList.contains('input-error')) {
                     target.classList.remove('input-error');
                 }
            });
            
            // Define a cor inicial dos inputs de data no load
             document.querySelectorAll('input[type="date"]').forEach(input => {
                if (input.value === '') {
                    input.style.color = '#6c757d';
                } else {
                    input.style.color = '#333';
                }
            });

        });
    </script>
</body>
</html>

